#!/bin/bash

trap '' INT TSTP

# .: DEPENDÊNCIAS :.
pacman -S --noconfirm --needed wget git p7zip bash-completion

# .: CRIA PASTAS :.
mkdir -p /temp /usr/share/backgrounds/Custom/ /usr/local/bin/

# .: REPOLOCAL :.
git clone --depth 1 https://github.com/arch4life/repolocal ; rm -rf /repolocal/.git
cd /repolocal/ ; repo-add ./repolocal.db.tar.gz ./*

# .: COPIA SCRIPTS, IMAGENS E CONFIGURAÇÃO DO USUÁRIO :.
cp  /archlinux/after-install /archlinux/addusers /archlinux/autologin /archlinux/setup-grub /archlinux/usys /usr/local/bin/ ; chmod +x /usr/local/bin/*
mkdir -p /usr/share/icons/ /usr/share/backgrounds/

# .: IDIOMA PADRAO DO SISTEMA :.
echo -e 'pt_BR.UTF-8 UTF-8\npt_BR ISO-8859-1' | tee /etc/locale.gen ; echo LANG=pt_BR.UTF-8 > /etc/locale.conf ; locale-gen ; export LANG=pt_BR.UTF-8

# .: LAYOUT DO TECLADO :.
loadkeys br-abnt ; echo -e "KEYMAP=br-abnt2\nFONT=Lat2-Terminus16\nFONT_MAP=" | tee /etc/vconsole.conf ; mkdir -p /etc/X11/xorg.conf.d ; echo -e 'Section "InputClass"\n         Identifier "Keyboard Defaults"\n         MatchIsKeyboard "yes"\n         Option "XkbLayout" "br"\nEndSection' | tee /etc/X11/xorg.conf.d/01-keyboard-layout.conf

# .: FUSO HORARIO :.
ln -sf /usr/share/zoneinfo/America/Recife /etc/localtime

# .: ASTERISCOS AO DIGITAR SENHA :.
sh -c "echo -e 'Defaults pwfeedback' >> /etc/sudoers"

# .: SUDO AOS USUARIOS WHEEL :.
sed -i '/%wheel ALL=(ALL) ALL/s/^#//' /etc/sudoers

# .: SENHA DO USUARIO ROOT :.
clear ; echo " "  ; echo "Senha para o usuário ROOT" ; echo " " ; passwd ; sleep 1

# .: CRIAR USUARIO :.
useradd -m -g users -G wheel,storage,power -s /bin/bash live
clear ; echo " "  ; echo "Senha para o usuário LIVE" ; echo " "
passwd live

# .: VARIÁVEL COM NOME DO USUÁRIO :.
export un=`grep /home/ /etc/passwd | cut -d: -f1`

# .: HOSTNAME :.
echo "arch-live" > /etc/hostname

# .: LOOK :.
cd /temp ; wget --no-check-certificate https://github.com/arch4life/look/raw/master/oranchelo-icon-theme.7z ; wget --no-check-certificate https://github.com/arch4life/look/raw/master/adapta-gtk-theme.7z ; wget --no-check-certificate https://github.com/arch4life/misc/raw/master/configs-de-wm/jwm-config-arch.7z
7z x -y adapta-gtk-theme.7z ; 7z x -y oranchelo-icon-theme.7z ; 7z x -y jwm-config-arch.7z
cd /usr/share/backgrounds/Custom/ ; wget --no-check-certificate  https://github.com/arch4life/backgrounds/raw/master/Sunset_Ocean_wallpaper.jpg

# JWM & Aplicativos
pacman -S --noconfirm --needed wget git xorg-server xorg-xinit xorg-xkill xorg-xrandr ntfs-3g exfat-utils dosfstools alsa-utils rsync xdg-user-dirs networkmanager wireless_tools wpa_supplicant wpa_actiond dialog ttf-dejavu gtk-engines gtk-engine-murrine sakura htop network-manager-applet tint2 volumeicon geany oblogout gparted lxsession wmctrl lxappearance file-roller pcmanfm scrot galculator gsimplecal feh gmrun ; pacman -S --noconfirm --needed jwm-git xdgmenumaker ; ln -sf /usr/bin/sakura /usr/bin/xterm ; clear
pacman -S --noconfirm --needed palemoon ; cd /etc/skel ; wget --no-check-certificate https://github.com/arch4life/applications/raw/master/browser/palemoonconfig.7z ; 7z x -y palemoonconfig.7z ; rm -f palemoonconfig.7z ; cd / ; clear
#pacman -S --noconfirm --needed conky ; clear # Conky

# .: BAIXA O SCREENFETCH :.
wget --no-check-certificate https://github.com/KittyKatt/screenFetch/raw/master/screenfetch-dev -O /usr/local/bin/screenfetch

# .: HABILITA / DESABILITA SERVIÇOS :.
systemctl enable -f NetworkManager ; systemctl enable -f dhcpcd ; systemctl disable -f avahi-daemon 

# .: BLOQUEIOS DO HOSTS :.
cd / ; cp /etc/hosts /etchosts ; cp /etc/hosts /etc/hosts.backup ; wget --no-check-certificate https://github.com/arch4life/misc/raw/master/docs/hosts.txt ; wget --no-check-certificate https://github.com/arch4life/misc/raw/master/docs/blockhosts ; cat blockhosts >> hosts.txt ; cat etchosts >> hosts.txt ; rm -f /etc/hosts ; mv /hosts.txt /etc/hosts ; chown root:root /etc/hosts ; chmod 755 /etc/hosts

# .: DESLIGAMENTO :.
chmod u+s /sbin/shutdown /sbin/poweroff /sbin/reboot

# .: CONFIGURANDO APLICATIVOS DO USUÁRIO :. 
export un=`grep /home/ /etc/passwd | cut -d: -f1`
rm -f /temp/*.7z ; chown -R root:root /temp/ ; chmod 755 -R /temp/
cp -rT /temp/ /
cp /archlinux/.zshrc /etc/skel/ ; mkdir -p /etc/skel/{"Desktop","Documentos","Downloads","Imagens","Modelos","Música","Público","Vídeos",".icons",".themes"}
cp -rT /etc/skel/ /home/$un/ ; mkdir -p /home/$un/.config/gtk-3.0
echo -e "file:///home/"$un"/V%C3%ADdeos Vídeos\nfile:///home/"$un"/Downloads Downloads\nfile:///home/"$un"/Documentos Documentos\nfile:///home/"$un"/Imagens Imagens\nfile:///usr/share/applications applications\nfile:///usr/share/backgrounds backgrounds" |  tee /home/"$un"/.config/gtk-3.0/bookmarks ; clear
chmod +x /usr/local/bin/* /usr/share/applications/*.desktop ; chown -R $un:root /home/$un/ ;  chown -R $un:root /opt/conky/
rm /etc/pacman.conf ; mv /etc/pacman.conf.repooff /etc/pacman.conf

# .: VERIFICA A INSTALACAO :.
clear ; echo " " ; echo "RESUMO DA INSTALAÇÃO" ; echo "---------------------" ; echo " " ; echo -n "Nome da máquina: " ; cat /etc/hostname ; echo -n "Usuário(s) ativo(s): " ; grep /home/ /etc/passwd | cut -d: -f1 ; echo -n "Grub instalado: " ; grub-install --version ; echo " " ; echo "- Para corrigir erro no criação do hostname, ao finalizar o script," ; echo "não encerre o chroot e digite nano /etc/hostname" ; echo "- Para corrigir erro na criação do usuário, ao finalizar o script, " ; echo "não encerre o chroot e digite addusers" ; echo "- Para corrigir erro na instalação do Grub, ao finalizar o script," ; echo "não encerre o chroot e digite setup-grub" ; echo " " ; echo "- Para finalizar a instação, siga os passos abaixo:" ; echo "a) Digite exit para sair do chroot." ; echo "b) Desmonte as unidades com umount -R /mnt" ; echo "d) Reinicie o sistema digitando reboot -f ou desligue-o com poweroff -f" ; echo " " ; echo " " ; echo "Pressione uma tecla para encerrar..." ; read tecla ; clear

# .: LIMPEZA DO SISTEMA :.
rm -f /usr/share/backgrounds/Custom/ubuntu* /usr/share/backgrounds/Custom/debian* /usr/share/backgrounds/Custom/solus*
rm -f /blockhosts /etchosts ; rm -f /*.7z ; rm -rf /archlinux /repolocal /temp
clear
#exit ; exit
